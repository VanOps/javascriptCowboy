# =============================================
# CI Workflow para Next.js
# Archivo: .github/workflows/ci-nextjs.yml
# =============================================

name: ğŸ¯ Next.js CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: 20.x

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Lint + Test + Build
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ci:
    name: ğŸ” CI - Lint, Test, Build
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ¨ Lint cÃ³digo
        run: npm run lint

      - name: ğŸ§ª Run tests
        run: npm test

      - name: ğŸ—ï¸ Build proyecto
        run: npm run build

      - name: ğŸ“Š Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: .next/
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Deploy (solo si CI pasa)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: ğŸš€ Deploy
    needs: ci
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: .next/

      # Deploy a Vercel (producciÃ³n)
      - name: ğŸš€ Deploy to Vercel (Production)
        if: github.ref == 'refs/heads/main'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          npm install -g vercel
          vercel --prod --token=$VERCEL_TOKEN --yes

      # Deploy a staging
      - name: â˜ï¸ Deploy to Staging (Develop)
        if: github.ref == 'refs/heads/develop'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          npm install -g vercel
          vercel --token=$VERCEL_TOKEN --yes

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: NotificaciÃ³n (siempre se ejecuta)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notify:
    name: ğŸ“¢ Notificar resultado
    needs: [ci, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“Š Resultado del workflow
        run: |
          echo "CI Status: ${{ needs.ci.result }}"
          echo "Deploy Status: ${{ needs.deploy.result }}"
          
          if [ "${{ needs.ci.result }}" == "failure" ]; then
            echo "âŒ CI fallÃ³ - deployment bloqueado"
            exit 1
          fi

# ğŸ” CONCEPTOS DEMOSTRADOS:
#
# 1. Matrix Strategy (opcional)
#    - Probar mÃºltiples versiones de Node.js
#    - strategy: matrix: node-version: [18.x, 20.x]
#
# 2. Artifacts
#    - upload-artifact: Guardar build entre jobs
#    - download-artifact: Reutilizar en deploy
#
# 3. Conditional execution
#    - if: github.ref == 'refs/heads/main'
#    - if: always() - ejecutar siempre
#
# 4. Job dependencies
#    - needs: ci - deploy solo si CI pasa
#
# 5. Secrets
#    - ${{ secrets.VERCEL_TOKEN }}
#    - Configurar en repo Settings â†’ Secrets
#
# SECRETS REQUERIDOS:
# - VERCEL_TOKEN
# - VERCEL_ORG_ID
# - VERCEL_PROJECT_ID
